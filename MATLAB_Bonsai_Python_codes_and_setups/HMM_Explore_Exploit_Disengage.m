% States: 'disengagement','Exploration','Exploitation'

TRANS_GUESS = (1/3)*ones(3,3); % 'Idle', 'explore', 'exploit'

behavior = {'Idle', 'App', 'Leave', 'Sit' , 'Walk', 'AppSniff', 'DeepInteract'};
EMIS_GUESS = [ ...
    0.4  0.1  0.1  0.1  0.1  0.1  0.1;...
    0.1  0.1  0.1  0.1  0.1  0.4  0.1;...
    0.1  0.1  0.1  0.1  0.1  0.1  0.4]; % just an initial emission matrix;  or all random / or all equal

load('ExpExp_HMM_TRANSITION_EMISION_TRAINED.mat')
load('Explore_Exploit_database.mat')

S = ExEx_database;

B6 = [];
for i = 1:length(S)
%             if strcmp(S(i).group,'VGAT_Inh')==1
                if strcmp(S(i).group,'Control')==1 
        B6 = [B6,i];
    end
end

Data = {};
for i = B6
    for j = 1:length(S(i).data)
        Data = [Data,S(i).data{1,j}];
    end
end

%% label ranking
Dur = 120; % movie duration in seconds
X = 0.5; %  (200ms per bin)
Xbin = 1/X;
total_bin_num = Dur*Xbin+1;
seqs = {};

for j = 1:length(Data)

    AppSniff= AppSniff(1:total_bin_num);
    DeepInteract= DeepInteract(1:total_bin_num);
    App= App(1:total_bin_num);
    Leave= Leave(1:total_bin_num);
    AppD= App(1:total_bin_num);
    LeaveD= Leave(1:total_bin_num);
    Sit = sit_binary(1:total_bin_num);
    Walk = walk_binary(1:total_bin_num);
    A1 = logical(App);
    A2 = logical(AppD);
    A3 = A1|A2;
    App = double(A3);
    A1 = logical(Leave);
    A2 = logical(LeaveD);
    A3 = A1|A2;
    Leave = double(A3);
    
    Enew = [App;Leave;Sit;Walk;AppSniff;DeepInteract];
    
    sequence = Enew.*repmat([1:6]',1,size(Enew,6));
    sequence = max(sequence,[],1);
    sequence = sequence(1:total_bin_num);
    sequence = sequence + 1; % to add idle
    seqs{j} = sequence;
    %
end

% [TRANS_EST2, EMIS_EST2] = hmmtrain(seqs, TRANS_GUESS, EMIS_GUESS); %
% trained only on control group

%% decode
color_groups = [213 94 0;0 158 115;0 114 178]/255;
Disengage_dur = [];
Explore_dur = [];
Exploit_dur = [];
STL = [];
for j = 1:length(Data)
    [PSTATES,logpseq] = hmmdecode(seqs{j},TRANS_EST2, EMIS_EST2);
    [x,ST_lab] = max(PSTATES,[],1);

    Disengage_dur = [Disengage_dur,length(find(ST_lab==1))];
    Explore_dur = [Explore_dur,length(find(ST_lab==2))];
    Exploit_dur = [Exploit_dur,length(find(ST_lab==3))];
    STL = [STL;ST_lab];
end

color_groups = [0 114 178;0 158 115;213 94 0]/255;
figure;
p_mean = pie([median(Exploit_dur*X),median(Explore_dur*X),median(Disengage_dur*X)]); legend({'Exploit','Explore','Disengage'},'FontSize',12);
p_mean(1).FaceColor = color_groups(1,:); p_mean(3).FaceColor = color_groups(2,:); p_mean(5).FaceColor = color_groups(3,:);
p_mean(2).FontSize = 12; p_mean(4).FontSize = 12; p_mean(6).FontSize = 12;
set(gcf,'color','white')
title('Control','FontSize',20)
